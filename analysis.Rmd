---
title: "Analysis"
output: html_document
date: '2023-04-14'
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
```

## First exploratory data 
```{r}

```

```{r Chris analysis}
personen <- read_delim(file = "data/protected_data/personen.csv", col_names = TRUE)
personen_hist <- read_delim(file = "data/protected_data/personen_hist.csv", col_names = TRUE)
firmen <- read_delim(file = "data/protected_data/firmen.csv", col_names = TRUE)
firmen_hist <- read_delim(file = "data/protected_data/firmen_hist.csv", col_names = TRUE)
relationen_person_firma <- read_delim(file = "data/protected_data/relationen_person_firma.csv", col_names = TRUE)
relationen_person_firma_hist <- read_delim(file = "data/protected_data/relationen_person_firma_hist.csv", col_names = TRUE)
relationen_firma_firma <- read_delim(file = "data/protected_data/relationen_firma_firma.csv", col_names = TRUE)
head(personen)
head(relationen_person_firma)

# Adjust data types


# Adjust "branche"
firmen$branche <- gsub(firmen$wz_code, replacement = "", pattern = "\\{|\\}")
firmen$branche <- strsplit(firmen$branche, ",")
firmen$branche <- lapply(firmen$branche, as.numeric)
firmen$branche <- lapply(firmen$branche, min)
firmen$branche <- substr(firmen$branche,1,2)
firmen <- firmen %>% mutate(branche = as.numeric(branche)) %>% 
  mutate(branchen_code = case_when(branche < 05 ~ "A", 
                                   branche < 10 ~ "B", 
                                   branche < 35 ~ "C", 
                                   branche < 45 ~ "E", 
                                   branche < 49 ~ "G", 
                                   branche < 55 ~ "H", 
                                   branche < 58 ~ "I", 
                                   branche < 64 ~ "J",
                                   branche < 68 ~ "K", 
                                   branche < 69 ~ "L", 
                                   branche < 77 ~ "M", 
                                   branche < 84 ~ "N", 
                                   branche < 85 ~ "O", 
                                   branche < 86 ~ "P", 
                                   branche < 90 ~ "Q", 
                                   branche < 97 ~ "R", 
                                   branche < 99 ~ "T", 
                                   branche == 99 ~ "U"))



# Definieren der URL und Parameter für die OpenStreetMap-API
url <- "https://nominatim.openstreetmap.org/search"
params <- list(q = "AGS-27-Code", format = "json", limit = 1)

get_coordinates <- function(land, plz, ort, stn_hnr) {
  url <- paste0("https://nominatim.openstreetmap.org/search?country=", land, "&postalcode=", plz, "&city=", ort, "&street=", stn_hnr, "&format=json&limit=1")
  response <- GET(url)
  if (response$status_code == 200) {
    json <- content(response, "text")
    data <- fromJSON(json)
    if (length(data) > 0) {
      lat <- as.numeric(data[[1]]$lat)
      lon <- as.numeric(data[[1]]$lon)
      return(c(lat, lon))
    } else {
      warning(paste0("No results found for address ", stn_hnr, ", ", plz, " ", ort, ", ", land))
    }
  } else {
    warning(paste0("API request failed for address ", stn_hnr, ", ", plz, " ", ort, ", ", land))
  }
  return(NA)
}

# Anwenden der Funktion auf die Spalten
firmen$coords <- apply(firmen[1], 1, function(x) get_coordinates(x["land"], x["plz"], x["ort"], x["stn_hnr"]))



anteile <- personen %>% 
  group_by(geschlecht) %>% 
  summarize(n_ges = n()) %>% 
  mutate(anteil_ges = n / sum(n_ges))

ggplot(anteile, aes(x = geschlecht, y = anteil_ges)) +
  geom_bar(stat = "identity")

personen_relationen <- merge(x = personen, relationen_person_firma, by = "pers_id")
personen_relationen %>%
  group_by(geschlecht, funktion) %>%
  count(funktion, name = "funktion_abs_haeufigkeiten") %>%
  filter(funktion %in% c("Geschaeftsfuehrer"))

firmen_relationen <- merge(firmen, relationen_person_firma, by = "firm_id")
firmen_relationen %>% group_by(firm_id, pers_id, funktion) %>%
  filter(funktion %>% c("Geschaeftsfuehrer")) %>%
  count(pers_id) %>%
  summarize(avg_employees = mean(number_of_employees, na.rm = TRUE))

firmenname_laenge_zeit <- firmen_hist %>%
  mutate(registrations_year = year(registrations_datum)) %>%
  group_by(registrations_year) %>%
  summarize(avg_nchar = mean(nchar(unique(firmenname)), na.rm = TRUE))

ggplot(data = firmenname_laenge_zeit, mapping = aes(x = registrations_year, avg_nchar)) +
  geom_line()

# Geschlechter-Anteile nach Gründungsjahr
anteile <- personen %>% 
  group_by(geschlecht) %>% 
  summarize(n_ges = n()) %>% 
  mutate(anteil_ges = n / sum(n_ges))

ggplot(anteile, aes(x = geschlecht, y = anteil_ges)) +
  geom_bar(stat = "identity")
```

# Diversity analysis
```{r diversity analysis}
# female representation in boards over time
relationen_person_firma_hist_fuehrung <- relationen_person_firma_hist %>%
  filter(funktion %in% c("Vorstandsvorsitzender", "Vorstand", "Direktor",
                         "Geschaeftsfuehrer", "Gruender", "Inhaber", "Kommanditist",
                         "Partner"))

relationen_fuehrung <- merge(x = personen, 
                                   y = relationen_person_firma_hist_fuehrung, 
                                   by = "pers_id", 
                                   all.x = FALSE, 
                                   all.y = TRUE) %>%
  filter(geschlecht %in% c("m", "f"), beginn_jahr <= 2022)

relationen_fuehrung_adv <- merge(x = firmen, 
                                   y = relationen_fuehrung, 
                                   by = "firm_id", 
                                   all.x = FALSE, 
                                   all.y = TRUE)


# Group data by year and gender, and count the number of occurrences
df_counts <- relationen_vorstand %>%
  group_by(beginn_jahr, geschlecht) %>%
  summarize(count = n())

# Calculate the total count for each year
df_totals <- df_counts %>%
  group_by(beginn_jahr) %>%
  summarize(total = sum(count))

# Calculate the relative frequency of each gender for each year
df_freq <- df_counts %>%
  left_join(df_totals, by = "beginn_jahr") %>%
  mutate(freq = count / total)

# Plot the results
ggplot(df_freq, aes(x = beginn_jahr, y = freq, color = geschlecht)) +
  geom_line() +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Year", y = "Relative Frequency", color = "Gender")

# average age in boards over time
```

# Function to plot gender diversity by "branche"
```{r}
diversity_branche <- function(df, branche) {
  df <- df %>%
    filter(branchen_code == !!branche)
  
  df_counts <- df %>%
  group_by(beginn_jahr, geschlecht) %>%
  summarize(count = n())

  # Calculate the total count for each year
  df_totals <- df_counts %>%
    group_by(beginn_jahr) %>%
    summarize(total = sum(count))
  
  # Calculate the relative frequency of each gender for each year
  df_freq <- df_counts %>%
    left_join(df_totals, by = "beginn_jahr") %>%
    mutate(freq = count / total)
  
  # Plot the results
  ggplot(df_freq, aes(x = beginn_jahr, y = freq, color = geschlecht)) +
    geom_line() +
    scale_y_continuous(labels = scales::percent) +
    labs(x = "Year", y = "Relative Frequency", color = "Gender")
  ggsave(paste("Plots/diversity_", branche, ".png", sep = ""),
         width = 12, height = 9)
}
```

```{r}
# Create Branchen Plots
branchen_codes <- unique(firmen$branchen_code)
for (branchen_code in branchen_codes) {
  diversity_branche(relationen_fuehrung_adv, branchen_code)
}
```

