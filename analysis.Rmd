---
title: "Analysis"
output: html_document
date: '2023-04-14'
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
```


## First exploratory data 
```{r}

```

```{r Chris analysis}
personen <- read_delim(file = "data/protected_data/personen.csv", col_names = TRUE)
personen_hist <- read_delim(file = "data/protected_data/personen_hist.csv", col_names = TRUE)
firmen <- read_delim(file = "data/protected_data/firmen.csv", col_names = TRUE)
firmen_hist <- read_delim(file = "data/protected_data/firmen_hist.csv", col_names = TRUE)
relationen_person_firma <- read_delim(file = "data/protected_data/relationen_person_firma.csv", col_names = TRUE)
relationen_person_firma_hist <- read_delim(file = "data/protected_data/relationen_person_firma_hist.csv", col_names = TRUE)
relationen_firma_firma <- read_delim(file = "data/protected_data/relationen_firma_firma.csv", col_names = TRUE)
head(personen)
head(relationen_person_firma)

# Adjust data types

# Definieren der URL und Parameter für die OpenStreetMap-API
url <- "https://nominatim.openstreetmap.org/search"
params <- list(q = "AGS-27-Code", format = "json", limit = 1)

get_coordinates <- function(land, plz, ort, stn_hnr) {
  url <- paste0("https://nominatim.openstreetmap.org/search?country=", land, "&postalcode=", plz, "&city=", ort, "&street=", stn_hnr, "&format=json&limit=1")
  response <- GET(url)
  if (response$status_code == 200) {
    json <- content(response, "text")
    data <- fromJSON(json)
    if (length(data) > 0) {
      lat <- as.numeric(data[[1]]$lat)
      lon <- as.numeric(data[[1]]$lon)
      return(c(lat, lon))
    } else {
      warning(paste0("No results found for address ", stn_hnr, ", ", plz, " ", ort, ", ", land))
    }
  } else {
    warning(paste0("API request failed for address ", stn_hnr, ", ", plz, " ", ort, ", ", land))
  }
  return(NA)
}

# Anwenden der Funktion auf die Spalten
firmen$coords <- apply(firmen[1], 1, function(x) get_coordinates(x["land"], x["plz"], x["ort"], x["stn_hnr"]))



anteile <- personen %>% 
  group_by(geschlecht) %>% 
  summarize(n_ges = n()) %>% 
  mutate(anteil_ges = n / sum(n_ges))

ggplot(anteile, aes(x = geschlecht, y = anteil_ges)) +
  geom_bar(stat = "identity")

personen_relationen <- merge(x = personen, relationen_person_firma, by = "pers_id")
personen_relationen %>%
  group_by(geschlecht, funktion) %>%
  count(funktion, name = "funktion_abs_haeufigkeiten") %>%
  filter(funktion %in% c("Geschaeftsfuehrer"))

firmen_relationen <- merge(firmen, relationen_person_firma, by = "firm_id")
firmen_relationen %>% group_by(firm_id, pers_id, funktion) %>%
  filter(funktion %>% c("Geschaeftsfuehrer")) %>%
  count(pers_id) %>%
  summarize(avg_employees = mean(number_of_employees, na.rm = TRUE))

firmenname_laenge_zeit <- firmen_hist %>%
  mutate(registrations_year = year(registrations_datum)) %>%
  group_by(registrations_year) %>%
  summarize(avg_nchar = mean(nchar(unique(firmenname)), na.rm = TRUE))

ggplot(data = firmenname_laenge_zeit, mapping = aes(x = registrations_year, avg_nchar)) +
  geom_line()

# Geschlechter-Anteile nach Gründungsjahr
anteile <- personen %>% 
  group_by(geschlecht) %>% 
  summarize(n_ges = n()) %>% 
  mutate(anteil_ges = n / sum(n_ges))

ggplot(anteile, aes(x = geschlecht, y = anteil_ges)) +
  geom_bar(stat = "identity")
```

# Diversity analysis
```{r diversity analysis}
# female representation in boards over time
relationen_person_firma_hist_vorstand <- relationen_person_firma_hist %>%
  filter(funktion %in% c("Vorstandsvorsitzender", "Vorstand"))

relationen_vorstand <- merge(x = personen, 
                                   y = relationen_person_firma_hist_vorstand, 
                                   by = "pers_id", 
                                   all.x = FALSE, 
                                   all.y = TRUE) %>%
  filter(geschlecht %in% c("m", "f"), beginn_jahr <= 2022)



# Group data by year and gender, and count the number of occurrences
df_counts <- relationen_vorstand %>%
  group_by(beginn_jahr, geschlecht) %>%
  summarize(count = n())

# Calculate the total count for each year
df_totals <- df_counts %>%
  group_by(beginn_jahr) %>%
  summarize(total = sum(count))

# Calculate the relative frequency of each gender for each year
df_freq <- df_counts %>%
  left_join(df_totals, by = "beginn_jahr") %>%
  mutate(freq = count / total)

# Plot the results
ggplot(df_freq, aes(x = beginn_jahr, y = freq, color = geschlecht)) +
  geom_line() +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Year", y = "Relative Frequency", color = "Gender")





relationen_vorstand %>% group_by(beginn_jahr, geschlecht) %>%
  summarize(n_ges = n()) %>% 
  mutate(anteil_ges = n / sum(n_ges))
  
  
ggplot(data = personen_relationen_hist_vorstand, 
       mapping = aes(x = beginn_jahr, y = ))


setDT(personen_hist)
setDT(relationen_person_firma_hist)

personen_relationen_hist <- personen_hist[relationen_person_firma_hist, on = "pers_id", allow.cartesian = TRUE]


personen_relationen_hist <- merge(x = personen_hist, relationen_person_firma_hist, by = "pers_id")
personen_relationen_hist %>%
  group_by(geschlecht, funktion) %>%
  count(funktion, name = "funktion_abs_haeufigkeiten") %>%
  filter(funktion %in% c("Geschaeftsfuehrer"))

# average age in boards over time
```

